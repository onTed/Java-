# CAP定理

## 1.分布式系统的三个指标

分布式系统的最大难点，就是各个节点的状态如何同步。CAP定理是这方面的基本定理，也是理解分布式系统的起点。

![img](https://github.com/onTed/program/blob/master/CAP/pic/bg2018071601.png)

## 2.CAP的含义

**C-->Consistency(一致性)**意思是，写操作之后的读操作，必须返回该值。例如，某条记录是v0，用户向服务器1发起了一个写操作，将其改为v1。接下来，用户的读操作就会得到v1。这就叫一致性。

问题是，用户有可能向服务器2发起读操作，由于服务器2并没有同步服务器1中的值，因此返回的是v0。服务器1和服务器2读操作的结果不一致，这就不满足一致性了。

为了让服务器2也能变为v1，就要在服务器1写操作的时候，服务器1向服务器2发送一条消息，要求服务器2也将v0改成v1。

**A-->Availability(可用性)**意思是，只要收到用户的请求，服务器就必须给出回应。

用户可以选择想服务器1或服务器2发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是v0还是v1,否则就不满足可用性。

**P-->Partition tolerance(分区容错性)**

大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。

![img](https://www.wangbase.com/blogimg/asset/201807/bg2018071601.png)

服务器G1和服务器G2是两台跨区的服务器。服务器G1向服务器G2发送一条消息，服务器G2可能无法收到。系统设计的时候，必须考虑到这种情况。

一般来说，分区容错是必须的，因此可以认为CAP的P总是成立。CAP定理告诉我们，一致性和可用性无法同时做到。

## 3.一致性和可用性的矛盾

一致性和可用性，为什么不可能同时成立？因为节点之间可能通信失败。

如果保证服务器G2的一致性，那么服务器G1必须在写操作是，锁定G2的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，服务器G2不能读写，没有了可用性。

如果保证了G2的可用性，那么势必不能锁定服务器G2，所以一致性又不能保证。

综上所述，服务器G2无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。























